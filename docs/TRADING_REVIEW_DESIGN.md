# 交易复盘功能设计 (Trading Review / 复盘)

## 一、目标与定位

- **产品目标**：在「社区 + 打卡 + 行情」之上，增加一个**对交易者有直接价值**的能力——帮助用户沉淀交易思考、养成复盘习惯，从而提升 App 粘性和留存。
- **核心价值**：
  - **对用户**：有地方记录「今天为什么赚/亏、下次怎么改进」，形成可回顾的复盘记录。
  - **对产品**：复盘与打卡、社区形成闭环（打卡 → 复盘 → 可选分享到社区），强化「每日打开」的习惯。

## 二、用户故事与使用路径

| 用户行为 | 场景 |
|---------|------|
| 收盘后打开 App | 先完成每日打卡（赚了/亏了） |
| 打卡完成后 | 被引导「简单写一句今天复盘」（或稍后在「我的」里进入复盘） |
| 写复盘 | 可选：今日盈亏原因、做得好的/要改进的、关注的标的（可选关联股票标签） |
| 回顾 | 在「我的」或独立入口查看历史复盘列表，按日查看 |
| 可选 | 将某条复盘「分享到社区」变成一条心得（用户主动选择，非自动） |

**设计原则**：复盘是**私有为主**（先服务用户自我反思），分享到社区是**可选的增强**，避免用户因「被公开」不愿写。

---

## 三、与现有模块的关系

- **打卡 (check_ins)**  
  - 复盘与打卡**按日期关联**：同一天一条打卡 + 可选一条复盘。  
  - 复盘列表/详情可展示当天打卡结果（赚了/亏了），数据来自已有 `check_ins`，不重复存。

- **社区 (posts)**  
  - 用户可把某条复盘**一键生成帖子**（预填内容，用户可编辑再发），实现「复盘 → 社区」的引流，而不是自动同步。

- **行情 / 自选**  
  - MVP 可只支持在复盘中写**文字**或**标签**（如 `#贵州茅台`）；后续可做「今日关注」勾选自选股，或复盘时 @某只股，与行情打通。

---

## 四、数据模型（单一数据源）

建议新增 CloudBase 集合：`trade_reviews`（或 `daily_reviews`）。

### 4.1 字段设计（单条复盘）

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `_id` | string | ✓ | 记录 ID（云开发自动） |
| `userId` | string | ✓ | 用户 ID |
| `date` | string | ✓ | 日期，YYYY-MM-DD，与 check_ins 对齐 |
| `content` | string | ✓ | 复盘正文（富文本或纯文本，MVP 先纯文本） |
| `createdAt` | Date | ✓ | 创建时间 |
| `updatedAt` | Date | ✓ | 最后更新时间 |
| `tags` | string[] | 否 | 话题/股票标签，如 ["贵州茅台","今日复盘"]，用于筛选与后续「分享到社区」带 Tag |

**约定**：  
- 同一用户同一天只允许**一条**复盘（upsert：有则更新，无则创建）。  
- 不在 `trade_reviews` 里冗余打卡结果；展示时用 `userId + date` 查 `check_ins` 得到「赚了/亏了」。

### 4.2 与打卡的关系

- 列表/详情页需要展示「当日盈亏」时：用 `userId` + `date` 调已有 `getCheckInHistory` 或单日查询 `check_ins`。  
- 不在复盘表存 `result`（yes/no），避免双源；若后端为降低读压力需要缓存，可在云函数层聚合后一次性返回。

---

## 五、MVP 范围建议

**先做「每日一条」的轻量复盘，不做逐笔交易记录。**

| 能力 | MVP | 说明 |
|------|-----|------|
| 写复盘 | ✓ | 按日期一条，content + 可选 tags |
| 复盘列表 | ✓ | 按日期倒序，展示日期、摘要、当日打卡结果（从 check_ins 取） |
| 复盘详情/编辑 | ✓ | 查看、编辑当天复盘 |
| 打卡后引导 | ✓ | 打卡完成后弹窗或底部 CTA：「今天要复盘一下吗？」→ 跳转写复盘 |
| 入口 | ✓ | 「我的」页明显入口 + 可选 Tab 或首页快捷入口 |
| 分享到社区 | 可做 | 将复盘内容转为帖子草稿/预填，用户确认后发布到 `posts` |
| 关联自选/行情 | 后续 | 复盘里选「今日关注」或 @股票，与行情联动 |
| 统计看板 | 后续 | 复盘天数、连续复盘 streak、与打卡 streak 联合展示 |

---

## 六、入口与信息架构

- **主要入口**
  - **「我的」页**：增加「交易复盘」或「我的复盘」入口，进入「复盘列表」。
  - **打卡完成后」：弹窗或 CTA「写今日复盘」→ 进入今日复盘编辑页（有则编辑，无则新建）。

- **次级入口**
  - 复盘列表顶部：「今日复盘」卡片（今日已写则显示摘要+「查看/编辑」，未写则「去写」）。

- **不主张 MVP 单独 Tab**：避免 Tab 过多；复盘作为「我的」下的核心能力即可，若后续数据好再考虑独立 Tab 或首页组件。

---

## 七、云函数与接口

| 接口 | 说明 |
|------|------|
| `getTradeReview(userId, date)` | 获取某用户某天的复盘，无则返回空。 |
| `upsertTradeReview(userId, date, content, tags?)` | 创建或更新当日复盘（同一用户同一天一条）。 |
| `getTradeReviewList(userId, limit?, beforeDate?)` | 分页拉取复盘列表，按 date 倒序。 |

如需在列表里带出当日打卡结果，可选方案：  
- **方案 A**：客户端拿到复盘列表后，用日期列表再调一次 `getCheckInHistory` 做本地合并。  
- **方案 B**：云函数 `getTradeReviewList` 内联查 `check_ins` 后一起返回（减少请求，推荐）。

---

## 八、后续迭代方向

1. **分享到社区**：复盘详情页「分享到社区」→ 预填帖子内容与 tags → 调现有发帖接口。  
2. **复盘统计**：连续复盘天数、本月复盘数、与打卡日历一起展示。  
3. **与行情/自选联动**：复盘时可勾选「今日关注」股票或输入 #股票名，列表/详情展示标的及当日涨跌。  
4. **提醒**：每日收盘后推送「今日复盘了吗？」（需消息能力）。  

---

## 九、小结

- **定位**：交易复盘 = 以「每日一条」的轻量记录帮助用户沉淀思考，并可选地与打卡、社区、行情联动，提高粘性。  
- **数据**：新集合 `trade_reviews`，与 `check_ins` 按 date 关联，不重复存盈亏结果，保持单一数据源。  
- **MVP**：写/编辑/列表/详情 + 打卡后引导 + 「我的」入口；分享到社区与统计可放在下一期。

按此设计即可在现有架构下实现「交易复盘」功能，并自然融入打卡与社区，形成对交易者有用的闭环。
